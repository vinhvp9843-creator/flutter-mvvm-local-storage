import 'package:flutter/material.dart';
import 'package:hive_flutter/hive_flutter.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await Hive.initFlutter();
  var box = await Hive.openBox('itemsBox');
  runApp(MyApp(box));
}

///MODEL 
class Item {
  final String title;
  Item(this.title);
}

///REPOSITORY 
class ItemRepository {
  final Box box;
  ItemRepository(this.box);

  List<Item> getItems() =>
      box.values.map((e) => Item(e.toString())).toList();

  Future<void> addItem(Item item) async {
    await box.add(item.title);
  }
}

///VIEWMODEL
class ItemViewModel extends ChangeNotifier {
  final ItemRepository repository;
  List<Item> items = [];

  ItemViewModel(this.repository) {
    loadItems();
  }

  void loadItems() {
    items = repository.getItems();
    notifyListeners();
  }

  Future<void> addItem(String title) async {
    await repository.addItem(Item(title));
    loadItems();
  }
}

///VIEW
class MyApp extends StatelessWidget {
  final Box box;
  MyApp(this.box);

  @override
  Widget build(BuildContext context) {
    return MaterialApp(home: HomeScreen(ItemViewModel(ItemRepository(box))));
  }
}

class HomeScreen extends StatefulWidget {
  final ItemViewModel vm;
  HomeScreen(this.vm);

  @override
  State<HomeScreen> createState() => _HomeScreenState();
}

class _HomeScreenState extends State<HomeScreen> {
  final controller = TextEditingController();

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text("MVVM + Hive")),
      body: AnimatedBuilder(
        animation: widget.vm,
        builder: (_, __) => ListView.builder(
          itemCount: widget.vm.items.length,
          itemBuilder: (_, i) =>
              ListTile(title: Text(widget.vm.items[i].title)),
        ),
      ),
      floatingActionButton: FloatingActionButton(
        child: Icon(Icons.add),
        onPressed: () async {
          if (controller.text.isEmpty) return;
          await widget.vm.addItem(controller.text);
          controller.clear();
        },
      ),
      bottomNavigationBar: Padding(
        padding: EdgeInsets.all(8),
        child: TextField(
          controller: controller,
          decoration: InputDecoration(
              hintText: "Nhập dữ liệu", border: OutlineInputBorder()),
        ),
      ),
    );
  }
}
